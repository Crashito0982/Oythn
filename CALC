def recalcular_estados_generico(df_hist_total: pd.DataFrame,
                                key_cols,
                                status_col: str) -> pd.DataFrame:
    """
    Recalcula ESTADO_REGISTRO con esta lógica:

      - Para cada clave lógica (key_cols), buscamos la(s) fila(s) con la
        FECHA_REF máxima (última versión).

      - Si la última versión es una baja ("Dado de baja..."):
            TODAS las filas de esa clave quedan ANTERIOR.

      - Si la última versión NO es baja:
            TODAS las filas de la última versión quedan VIGENTE,
            y el resto ANTERIOR.

    Esto permite que en la carga inicial, si hay duplicados con la misma
    versión, todos queden VIGENTE.
    """
    df = df_hist_total.copy()

    # 1) FECHA_REF: prioridad FECHA_CAMBIO, luego FECHA_CREACION
    if "FECHA_CAMBIO" in df.columns:
        df["FECHA_REF"] = df["FECHA_CAMBIO"]
    else:
        df["FECHA_REF"] = pd.NaT

    if "FECHA_CREACION" in df.columns:
        mask = df["FECHA_REF"].isna()
        df.loc[mask, "FECHA_REF"] = df.loc[mask, "FECHA_CREACION"]

    # Por prolijidad
    df.sort_values(list(key_cols) + ["FECHA_REF"], inplace=True)

    # 2) FECHA_REF máxima por clave lógica
    df["MAX_FECHA_REF"] = df.groupby(list(key_cols))["FECHA_REF"].transform("max")

    # Marca: esta fila pertenece a la "última versión" de su clave
    df["ES_ULTIMA_VERSION"] = df["FECHA_REF"] == df["MAX_FECHA_REF"]

    # 3) Definimos una clave interna para no usar apply
    if len(key_cols) == 1:
        df["_KEY_"] = df[key_cols[0]]
    else:
        df["_KEY_"] = list(zip(*(df[col] for col in key_cols)))

    # Filas de última versión por clave
    ultimas = df[df["ES_ULTIMA_VERSION"]].copy()
    ultimas["ES_BAJA"] = ultimas["OBS_CAMBIO"].fillna("").str.contains(
        r"^\s*Dado de baja\b", case=False, na=False, regex=True
    )

    # Conjunto de claves cuya ÚLTIMA versión es una baja
    ids_baja = set(ultimas.loc[ultimas["ES_BAJA"], "_KEY_"])

    # 4) Por defecto todos ANTERIOR
    df[status_col] = "ANTERIOR"

    # 5) Filas vigentes:
    #    - pertenecen a la última versión de su clave
    #    - y su clave NO está en el conjunto de bajas
    mask_vig = df["ES_ULTIMA_VERSION"] & ~df["_KEY_"].isin(ids_baja)
    df.loc[mask_vig, status_col] = "VIGENTE"

    # Limpieza de columnas auxiliares
    df.drop(columns=["FECHA_REF", "MAX_FECHA_REF", "ES_ULTIMA_VERSION", "_KEY_"],
            inplace=True)

    return df
