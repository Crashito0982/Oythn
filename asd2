USE AT_CMDTS;
GO

CREATE OR ALTER PROCEDURE dbo.sp_RefrescarTarjetasPendientes
    @DiasAtras INT = 15  -- por defecto, 15 dÃ­as hacia atrÃ¡s
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FechaDesde DATE;

    -------------------------------------------------------------------
    -- RANGO DE FECHAS DINÃMICO
    -------------------------------------------------------------------
    -- Por defecto: usar @DiasAtras dÃ­as hacia atrÃ¡s desde hoy
    SET @FechaDesde = DATEADD(DAY, -@DiasAtras, CAST(GETDATE() AS DATE));

    -- Si querÃ©s probar meses en lugar de dÃ­as, podÃ©s cambiar la lÃ­nea anterior por:
    -- 1 mes atrÃ¡s:
    -- SET @FechaDesde = DATEADD(MONTH, -1, CAST(GETDATE() AS DATE));
    -- 2 meses atrÃ¡s:
    -- SET @FechaDesde = DATEADD(MONTH, -2, CAST(GETDATE() AS DATE));
    -- 3 meses atrÃ¡s:
    -- SET @FechaDesde = DATEADD(MONTH, -3, CAST(GETDATE() AS DATE));

    -------------------------------------------------------------------
    -- LIMPIAR LA TABLA DESTINO
    -------------------------------------------------------------------
    TRUNCATE TABLE dbo.TC_TarjetasPendientes;

    -------------------------------------------------------------------
    -- CTE DE EVENTOS
    --  - TieneEntregaReciente: EVTTDI = 1 dentro de @FechaDesde
    --  - TieneEstadoFinal: cualquier 16/19/70
    -------------------------------------------------------------------
    ;WITH EVT AS (
        SELECT
              E.DOCID
            , MAX(
                CASE 
                    WHEN E.EVTTDI = 1 
                         AND E.EVTFCH >= @FechaDesde THEN 1 
                    ELSE 0 
                  END
              ) AS TieneEntregaReciente
            , MAX(
                CASE 
                    WHEN E.EVTTDI IN (16,19,70) THEN 1 
                    ELSE 0 
                  END
              ) AS TieneEstadoFinal
        FROM LGLIB_LGMEVT E
        WHERE E.EVTTDI IN (1,16,19,70)
        GROUP BY E.DOCID
    )
    INSERT INTO dbo.TC_TarjetasPendientes (
          ID_LOGISTICA
        , FECHA_INGRESO_SOLICITUD
        , NUMERO_CLIENTE
        , NUMERO_DOCUMENTO
        , SITUACION_TC
        , ESTADO_ACTIVACION      -- ðŸ‘ˆ nueva columna en la tabla destino
        , TIPO_TARJETA_DESC
        , FechaDesde
        , FechaEjecucion
    )
    SELECT
          A.ID_LOGISTICA
        , A.FECHA_INGRESO_SOLICITUD
        , A.NUMERO_CLIENTE
        , A.NUMERO_DOCUMENTO
        , A.SITUACION_TC
        , A.ESTADO_ACTIVACION    -- ðŸ‘ˆ viene de SOL_ALTA_TC
        , A.TIPO_TARJETA_DESC
        , @FechaDesde          AS FechaDesde
        , SYSUTCDATETIME()     AS FechaEjecucion   -- o GETDATE() si querÃ©s hora local
    FROM CORPDW_V_R_SOL_ALTA_TC A
    JOIN LGLIB_LGMDOC C
        ON C.DOCID = A.ID_LOGISTICA
    JOIN ODSP_LGLIB_LGMTDC T
        ON  T.TDCPRI = C.DOCPRI
        AND T.TDCID  = C.DOCTDI
        AND (
                (T.TDCPRI = 'TARJ.C' AND T.TDCID IN (1,36,37,70,89,116,132))
             OR (T.TDCPRI = '105'    AND T.TDCID = 89)
            )
    JOIN EVT E
        ON E.DOCID = A.ID_LOGISTICA
    WHERE A.ID_LOGISTICA IS NOT NULL
      -------------------------------------------------------------------
      -- EXCLUIR GIFT / GOURMET / PREPAGA
      -------------------------------------------------------------------
      AND COALESCE(A.CANA_VENTA_TJT_DESC,'') NOT LIKE 'GIFT CARD%'
      AND COALESCE(A.CANA_VENTA_TJT_DESC,'') NOT LIKE 'GOURMET CARD%'
      AND COALESCE(A.CANA_VENTA_TJT_DESC,'') NOT LIKE 'PREPAGA%'
      -------------------------------------------------------------------
      -- SOLO TARJETAS ENTREGADAS (RECIENTE) Y SIN ESTADO FINAL
      -------------------------------------------------------------------
      AND E.TieneEntregaReciente = 1
      AND E.TieneEstadoFinal     = 0;
END;
GO
