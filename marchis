USE AT_CMDTS;
GO

CREATE OR ALTER PROCEDURE dbo.sp_RefrescarTarjetasPendientes
    @DiasAtras INT = 15  -- por defecto, 15 dÃ­as hacia atrÃ¡s
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @FechaDesde DATE;

    -------------------------------------------------------------------
    -- RANGO DE FECHAS DINÃMICO
    -------------------------------------------------------------------
    -- OpciÃ³n por defecto: usar @DiasAtras dÃ­as hacia atrÃ¡s
    SET @FechaDesde = DATEADD(DAY, -@DiasAtras, CAST(GETDATE() AS DATE));

    -- Si querÃ©s probar por meses en vez de dÃ­as, podÃ©s comentar la lÃ­nea
    -- anterior y usar UNA de estas opciones:
    --
    -- 1 mes atrÃ¡s:
    -- SET @FechaDesde = DATEADD(MONTH, -1, CAST(GETDATE() AS DATE));
    --
    -- 2 meses atrÃ¡s:
    -- SET @FechaDesde = DATEADD(MONTH, -2, CAST(GETDATE() AS DATE));
    --
    -- 3 meses atrÃ¡s:
    -- SET @FechaDesde = DATEADD(MONTH, -3, CAST(GETDATE() AS DATE));

    -------------------------------------------------------------------
    -- LIMPIAR LA TABLA DESTINO
    -------------------------------------------------------------------
    TRUNCATE TABLE dbo.TC_TarjetasPendientes;

    -------------------------------------------------------------------
    -- CTE DE EVENTOS
    -------------------------------------------------------------------
    ;WITH EVT AS (
        SELECT
              E.DOCID
            , MAX(
                CASE 
                    WHEN E.EVTTDI = 1 
                         AND E.EVTFCH >= @FechaDesde THEN 1 
                    ELSE 0 
                  END
              ) AS TieneEntregaReciente
            , MAX(
                CASE 
                    WHEN E.EVTTDI IN (16,19,70) THEN 1 
                    ELSE 0 
                  END
              ) AS TieneEstadoFinal
        FROM LGLIB_LGMEVT E
        WHERE E.EVTTDI IN (1,16,19,70)
        GROUP BY E.DOCID
    )
    INSERT INTO dbo.TC_TarjetasPendientes (
          ID_LOGISTICA
        , DOCID
        , NRO_CLIENTE       -- ðŸ‘ˆ ahora lo cargamos
        , FechaDesde
        , FechaEjecucion
    )
    SELECT
          A.ID_LOGISTICA
        , C.DOCID
        , A.NUMERO_CLIENTE  -- ðŸ‘ˆ viene de CORPDW_V_R_SOL_ALTA_TC
        , @FechaDesde          AS FechaDesde
        , SYSUTCDATETIME()     AS FechaEjecucion
    FROM CORPDW_V_R_SOL_ALTA_TC A
    JOIN LGLIB_LGMDOC C
        ON C.DOCID = A.ID_LOGISTICA
    JOIN ODSP_LGLIB_LGMTDC T
        ON  T.TDCPRI = C.DOCPRI
        AND T.TDCID  = C.DOCTDI
        AND (
                (T.TDCPR  = 'TARJ.C' AND T.TDCID IN (1,36,37,70,89,116,132))
             OR (T.TDCPRI = '105'    AND T.TDCID = 89)
            )
    JOIN EVT E
        ON E.DOCID = A.ID_LOGISTICA
    WHERE A.ID_LOGISTICA IS NOT NULL
      AND A.NUMERO_CLIENTE IS NOT NULL          -- ðŸ‘ˆ para no violar NOT NULL
      AND COALESCE(A.CANA_VENTA_TJT_DESC,'') NOT LIKE 'GIFT CARD%'
      AND COALESCE(A.CANA_VENTA_TJT_DESC,'') NOT LIKE 'GOURMET CARD%'
      AND E.TieneEntregaReciente = 1
      AND E.TieneEstadoFinal     = 0;
END;
GO
